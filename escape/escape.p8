pico-8 cartridge // http://www.pico-8.com
version 43
__lua__
flry=99
hovered=nil
held=nil
ptr={x=64,y=64}
nav={}
inv_open=false
--debug stuff
dbg=""
draw_hb=false
rf=rectfill

function _init()
	scenes=init_scenes()
	scene=scenes["start"]
	init_nav()
	init_inv_btn()
end

function _update60()
	dbg=nil
	if inv_open then
		update_inv()
		return
	end
	
	if
		btnp(‚û°Ô∏è) or
		btnp(‚¨ÖÔ∏è) or
		btnp(‚¨ÜÔ∏è) or
		btnp(‚¨áÔ∏è) or
		btnp(‚ùé) or
		btnp(üÖæÔ∏è)
	then
		msg=nil
	end
	
	if(btn(‚û°Ô∏è))ptr.x+=1
	if(btn(‚¨ÖÔ∏è))ptr.x-=1
	if(btn(‚¨ÜÔ∏è))ptr.y-=1
	if(btn(‚¨áÔ∏è))ptr.y+=1
	ptr.x=mid(0,127,ptr.x)
	ptr.y=mid(0,127,ptr.y)
	
	hover()
	
	if btnp(üÖæÔ∏è) and hovered~=nil then
		hovered:act()
		held=nil
	end
	if (btnp(‚ùé)) held=nil
end

function _draw()
	cls(1)
	scene:draw()
	for item in all(scene.items) do
		if(not item.hide and item.draw)item:draw()
	end
	inv_btn:draw()
	if inv_open then
		draw_inv()
	else
		draw_ptr()
		draw_msg()
	end
--	print(ptr.x..":"..ptr.y,0,0,10)
end

function draw_ptr()
	if nav.r or nav.l or nav.b then
		draw_nav_ptr()
	elseif held~=nil then
		draw_item_ptr()
	else
		draw_normal_ptr()
	end
end

function draw_nav_ptr()
	if nav.r then
		spr(2,ptr.x-7,ptr.y-3)
	elseif nav.l then
		spr(3,ptr.x,ptr.y-3)
	elseif nav.b then
		spr(4,ptr.x-4,ptr.y-7)
	end
end

function draw_item_ptr()
	spr(held.sp,ptr.x-4,ptr.y-4)
	if(hovered~=nil)draw_bang()
end

function draw_bang()
	local x=ptr.x+5
	if(ptr.x>120)x=ptr.x-6
	line(x,ptr.y-5,x,ptr.y-3,10)
	pset(x,ptr.y-1,10)
end

function draw_normal_ptr()
	if hovered==nil then 
		sspr(8,0,3,3,ptr.x-1,ptr.y-1)
	else
		sspr(11,0,5,5,ptr.x-2,ptr.y-2)
	end
end

function hover()
	hovered=nil
	nav={}
	if colliding(ptr,nav_r) and scene.r then
		nav.r=true
		hovered=nav_r
	elseif colliding(ptr,nav_l) and scene.l then
		nav.l=true
		hovered=nav_l
	elseif colliding(ptr,nav_b) and scene.b then
		nav.b=true
		hovered=nav_b
	end
	
	for i in all(scene.items) do
		if(colliding(ptr,i) and not i.hide )hovered=i
	end
	
	if(colliding(ptr,inv_btn))hovered=inv_btn
end

function colliding(ptr,itm)
	return itm.x~=nil and 
		ptr.x>=itm.x and
		ptr.x<=itm.x+itm.w and
		ptr.y>=itm.y and
		ptr.y<=itm.y+itm.h
end

function draw_msg()
	if msg==nil then return end
	local lines=split(msg,"\n")
	local longest=0
	for l in all(lines) do
		if #l>longest then
			longest=#l
		end
	end
	
	local w=(longest)*4
	local h=#lines*6
	local padx=(128-w)/2
	local pady=(128-h)/2
	--background
	rf(
		padx,pady,
		padx+w,pady+h,
		12)
	--border
	rect(
		padx-1,pady-1,
		padx+w+1,pady+h+1,
		7)
	--text
	print(
		msg,
		padx+1,pady+1,
		0)
end


-->8
function init_scenes()
	return{
		start=init_start(),
		books=init_books(),
		kitchen=init_kitchen(),
		basement=init_basement(),
		piano_rm=init_piano_rm()
	}
end

function init_nav()
	nav={}
	nav_r={
		x=120,y=16,w=8,h=96,
		act=function()
			navigate("r")
		end
	}
	nav_l={
		x=0,y=16,w=8,h=96,
		act=function()
			navigate("l")
		end
	}
	nav_b={
		x=16,y=120,w=96,h=8,
		act=function()
			navigate("b")
		end
	}
end

function navigate(dir)
	if(scene[dir])go(scene[dir])
end

function go(scn_name)
	scene=scenes[scn_name]
	ptr={x=64,y=64}
	hovered=nil
	held=nil
	nav={}
end

function pickup(item,rm)
	rm=rm or true
	add(inv,item)
	if rm then
		scn_rm(item.name)
	end
	--sfx pickup
	msg="got "..item.name.."!"
end

function scn_rm(item_name)
	items_rm(scene.items,item_name)
end

function inv_rm(item_name)
	items_rm(inv,item_name)
end

function items_rm(items,name)
	for i=1,#items do
		if items[i].name==name then
			deli(items,i)
			return
		end
	end
end

function wrong_item(action)
	--sfx no
--	assert(action!=nil)
--	assert(held!=nil)
--	assert(held.name!=nil)
	msg="you can't "..action.."\nwith "..article(held.name)..held.name
end

function article(name)
	if name[-1]=="s" or name=="sheet music" then return "" end
	for v in all({"a","e","i","o","u"}) do
		if(name[1]==v)return "an "
	end
	return "a "
end

function get_item(name)
	for i in all(scene.items) do
		if(i.name==name)return i
	end
end
-->8
--scenes
door_locked=true
function init_start()
	return {
		l="books",
		r="piano_rm",
		draw=function(self)
			std_bg()
			--window
			rf(104,8,127,48,7)
			rf(106,10,125,25,12)
			rf(106,29,125,46,12)
			sspr(8,8,11,6,111,13)
			sspr(6,14,20,7,106,40)
			-- drawer
			line(3,71,38,71,15)
			rf(3,72,38,78,4)
			rect(7,73,34,77,1)
			sspr(19,8,6,3,18,74)
			rf(3,79,5,100,4)
			rf(36,79,38,100,4)
		end,
		items=init_start_items()
	}
end

function init_start_items()
	local door={
		x=51,y=33,w=37,h=64,
		act=function()
			msg="a door leading\nto the outside.\nit's locked."
		end,
		draw=function()
			draw_door(48)
		end
	}
	local lock={
		name="lock",
		x=80,y=60,w=6,h=15,
		act=function()
			if held==nil then
				msg="looks like you'll\nneed a key."
				--todo sfx
			elseif held.name=="key" then
				msg="you unlock the door!"
				--sfx unlock
				door_locked=false
				scn_rm("lock")
				inv_rm("key")
			else
				--wrong item
			end
		end
	}
	local hole={
		x=47,y=103,w=44,h=5,
		draw=function()
			rf(48,103,90,107,1)
			line(47,104,47,107,1)
			line(91,104,91,107,1)
			rf(61,104,62,107,4)
			rf(75,104,76,107,4)
			line(63,107,74,107,4)
		end,
		act=function()
			go("basement")
		end,
		hide=true
	}
	local rug={
		name="rug",
		x=39,y=101,w=62,h=9,
		act=function()
		 msg="throwing aside the rug\nreveals a ladder\nleading to a cellar."
			hole.hide=false
			scn_rm("rug")
			--todo sfx
		end,
		draw=function()
			ovalfill(39,102,100,109,5)
			ovalfill(39,101,100,108,15)
			oval(44,103,95,106,4)
		end
	}
	local grate={
		x=8,y=5,w=23,h=23,
		act=function()
			go("grate")
		end,
		draw=function()
			rect(8,5,31,26,5)
			local cs={13,6,5}
			for i=0,6 do
				for j=0,2 do
					line(9,6+i*3+j,30,6+i*3+j,cs[j+1])
				end
			end
		end
	}
	local radio={
		x=9,y=57,w=22,h=14,
		act=function()
			go("radio")
		end,
		draw=function()
			palt(0b0000000000000010)
			sspr(26,8,22,14,9,57)
			palt()
			line(26,44,26,56,6)
			pset(25,44,6)
		end
	}
	local drawer={
		name="drawer",
		x=9,y=73,w=25,h=4,
		act=function()
			pickup({
				name="pencil",
				weight=5,
				desc="2b or not 2b?\nthat is the pencil.",
				sp=48
			})
			scn_rm("drawer")
			msg="you find a pencil\nin the drawer."
		end
	}
	local clrbox={
		x=96,y=84,w=23,h=14,
		act=function()
			go("clrbox")
		end,
		draw=function()
			sspr(48,8,23,15,96,84)
		end
	}
	
	return {
		door,lock,rug,grate,radio,
		drawer,clrbox,hole
	}
end

function std_bg()
	rf(0,0,128,flry,2)
	line(0,flry,128,flry,5)
	rf(0,flry+1,128,128,3)
end

function draw_door()
	rf(48,30,91,98,4)
	rect(50,32,89,98,1)
	line(50,39,50,43,9)
	line(50,62,50,66,9)
	line(50,87,50,91,9)
	--lock
	palt(0b0000000000000010)
	sspr(0,8,6,14,80,60)
	palt()
end

function draw_door(x,white)
	if white then
		pal(4,7)
		pal(9,6)
	end
	rf(x,30,x+43,98,4)
	rect(x+2,32,x+41,98,1)
	line(x+2,39,x+2,43,9)
	line(x+2,62,x+2,66,9)
	line(x+2,87,x+2,91,9)
	--lock
	if white then
		pal(9,5)
		pal(10,6)
	end
	palt(0b0000000000000010)
	sspr(0,8,6,14,x+32,60)
	palt()
	pal()
end

bdoor_locked=true
paper_down=false
key_pushed=false
function init_books()
	return {
		l="kitchen",
		r="start",
		draw=function()
			std_bg()
			draw_door(11,true)
			--shelf
			rf(70,13,118,98,4)
			rf(73,17,115,37,1)
			rf(73,41,115,61,1)
			rf(73,65,115,85,1)
		end,
		items=init_book_items()
	}
end

function init_book_items()
local door={
		x=11,y=30,w=37,h=64,
		act=function()
			msg="the door is locked."
		end,
		draw=function()
			draw_door(11,true)
		end
	}
	local lock={
		name="lock",
		x=44,y=60,w=6,h=15,
		act=function()
			if held==nil then
				if key_pushed then
					msg="you peep through the\nkeyhole into what\nappears to be a\nbathroom."
				else
					msg="you try to look\nthrough the keyhole\nbut something is\nblocking it from\nthe other side."
				end
			elseif held.name=="hatpin" then
				if paper_down then
					key_pushed=true
					msg="you push the object\nout of the keyhole\nand it falls onto\nthe sheet music below."
					inv_rm("hatpin")
					--sfx pushkey
				else
					msg="if you do that now\nyou won't be able\nto reach what\nfalls out."
				end
			elseif held.name=="bkey" then
				msg="you unlock the door."
				inv_rm("bkey")
				scn_rm("lock")
				--sfx unlock
				bdoor_locked=false
			else
				--wrong item
			end
		end
	}
	local items={door,lock}
	book_clrs={
		o=0,
		r=0,
		g=0
	}
	local books=nil
	while 
		book_clrs.o==0 or 
		book_clrs.r==0 or 
		book_clrs.g==0 or
		book_clrs.o>9 or 
		book_clrs.r>9 or 
		book_clrs.g>9 
	do
		books=gen_books()
	end
	for book in all(books) do
		add(items,book)
	end
	return items
end

function gen_books()
	book_clrs={
		o=0,
		r=0,
		g=0
	}
	local books={}
	local clrs={
		{8,2},{9,4},{3,5},{12,1},
		{14,8},{13,5},{4,5}
	}
	local last_clr=nil
	local bk_txts=split(
	"the cadbury tales;incorrect trivia vol. 2;the end-bulbs of krause;doby mick;how to drain your dragon;my life - sleve mcdichael;the little book of snails;the invincible sponge;fun with lying;the big book of snails;cooking with ogg;how to finish anyth...;book titles for dummies;for whom the belt holes;the ill lad;the oddish sea;the alphabet pt. 2;the dogan;anna karmina burana;birds and other hoaxes;cream and pastryment;the bobbitt;jude the obnoxious;ethics for toddlers;all about coffee tables;the jelloship of the ring mold;the cherry pies of windsor;speling is eesy;whales are fish too;your microwave is listening;gary podder;the chronicles of arby's;not a secret hiding spot;space jelly;mein harumph;the hunchback of scuzz holler"
	,";")
	for top in all({17,41,65}) do
		local sw=43
		while sw>0 do
			local x=73+43-sw
			local w=flr(rnd(5))+2
			if (sw<=6) w=sw
			local g=flr(rnd(7))+3
			local y=top+g
			local h=21-g
			local clr=rnd(clrs)
			while
				clr==last_clr or
				(sw==43 or sw<=6) and clr[1]==4
			do
				clr=rnd(clrs)
			end
			if(clr[1]==8)book_clrs.r+=1
			if(clr[1]==9)book_clrs.o+=1
			if(clr[1]==3)book_clrs.g+=1 
			last_clr=clr
			local bumps=rnd()<0.2
			local by1=y+flr(h/5)
			local by2=y+h-1-flr(h/5)
			local thickness=flr(rnd(2))
			local txt=rnd(bk_txts)
			del(bk_txts,txt)
			add(books,{
				x=x,y=y,w=w,h=h-1,
				txt=txt,
				act=function()
					msg=txt
				end,
				draw=function()
					rf(x,y,x+w-1,y+h-1,clr[1])
					if(clr[1]==4)line(x,y+h-1,x+w,y+h-1,clr[2])
					if bumps and clr[1]~=4 then
						rf(x,by1,x+w-1,by1+thickness,clr[2])
						rf(x,by2,x+w-1,by2+thickness,clr[2])
					end
				end
			})
			sw-=w
		end
	end
	return books
end

function init_kitchen()
	return {
		r="books",
		draw=function()
			draw_encoded("8080410000134003001f4003001f4003001f4007a0030001a00e000140030001a00e0001a00e000140030001a00e0001a00e000140030001a00e0001a00e00014007a0030001a00e000140030001a00e0001a00e000140030001a00e0001a00e000140030001a00e0001a00e00014007a0030001a00e000140030001a00e0001a00e000140030001a00e0001a00e000140030001a00e0001a00e00014007a0030001a00e000140030001a00e0001a00e000140030001a00e0001a00e000140030001a00e0001a00e00014007a0030001a00e000140030001a00e0001a00e000140030001a00e0001a00e000140030001a00e0001a00e00014007a0030001a00e000140030001a00e0001a00e000140030001a00e0001a00e000140030001a00e0001a00e00014007a0030001a00e000140030001a00e0001a00e000140030001a00e0001a00e000140030001a00e0001a00e00014007a0030001a00e000140030001a00e0001a00e000140030001a00e0001a00e000140030001a00e0001a00e00014008a0020001a0024001a00b000140030001a00b4001a0020001a0024001a00b000140030001a00b4001a0020001a0024001a00b000140030001a00b4001a0020001a0024001a00b00014009a0010001a0014003a00a000140030001a00a4003a0010001a0014003a00a000140030001a00a4003a0010001a0014003a00a000140030001a00a4003a0010001a0014003a00a00014008a0020001a0024001a00b000140030001a00b4001a0020001a0024001a00b000140030001a00b4001a0020001a0024001a00b000140030001a00b4001a0020001a0024001a00b00014007a0030001a00e000140030001a00e0001a00e000140030001a00e0001a00e000140030001a00e0001a00e00014007a0030001a00e000140030001a00e0001a00e000140030001a00e0001a00e000140030001a00e0001a00e00014007a0030001a00e000140030001a00e0001a00e000140030001a00e0001a00e000140030001a00e0001a00e00014007a0030001a00e000140030001a00e0001a00e000140030001a00e0001a00e000140030001a00e0001a00e00014007a0030001a00e000140030001a00e0001a00e000140030001a00e0001a00e000140030001a00e0001a00e00014007a0030001a00e000140030001a00e0001a00e000140030001a00e0001a00e000140030001a00e0001a00e00014007a0030001a00e000140030001a00e0001a00e000140030001a00e0001a00e000140030001a00e0001a00e00014007a0030001a00e000140030001a00e0001a00e000140030001a00e0001a00e000140030001a00e0001a00e00014007a0030001a00e000140030001a00e0001a00e000140030001a00e0001a00e000140030001a00e0001a00e0001400700134003001f4003001f4003001f41070080f01a000160250001f059000160250001f059000160250001f0140028f01d0001601600046003000460040001f0130001c0280001f01c0001601600046003000460040001f0130001c0280001f01c000160250001f0130001c0280001f01d0025f0140001c0280001f0560001c0280001f0560001c0040003c0210001f0560001c004000160010001c0210001f0560001c004000160010001c0210001f0560001c004000160010001c0210001f0560001c004000160010001c0210001f0560001c004000160010001c0210001f0560001c004000160010001c0210001f0560001c004000160010001c0210001f0560001c004000160010001c0210001f0560001c004000160010001c0210001f0560001c004000160010001c0210001f0560001c0040003c0210001f0560001c0280001f0560001c0280001f0560001c0280001f0560002c0260002f056002af0560002c0260002f0560001c0280001f0560001c0280001f0560001c0280001f01d0025f0140001c0280001f01c000160250001f0130001c0280001f01c000160250001f0130001c0280001f01c000160250001f0130001c0040003c0210001f01c000160250001f0130001c004000160010001c0210001f01c000160250001f0130001c004000160010001c0210001f01c00016004500b6008500b60030001f0130001c004000160010001c0210001f01c0027f0130001c004000160010001c0210001f0020019f001000160250001f0130001c004000160010001c0210001f00240180001f001000160050003600900036009000360050001f0130001c004000160010001c0210001f00240180001f001000160040005600700056007000560040001f0130001c004000160010001c0210001f00240180001f001000160040005600700056007000560040001f0130001c004000160010001c0210001f0020019f001000160050003600900036009000360050001f0130001c004000160010001c0210001f002a0050001a00f000140020001f001000160250001f0130001c004000160010001c0210001f002a0050001a00f000140020001f0010027f0130001c004000160010001c0210001f002a0050001a00f000140020001f00100016009000160100001600a0001f0130001c004000160010001c0210001f002a0050001a00f000140020001f00100016009000160100001600a0001f0130001c0040003c0210001f002a0050001a00f000140020001f00100016005001b60050001f0130001c0280001f002a0050001a00f000140020001f00100016005000150137001500170015003000160050001f0130001c0280001f002a0050001a00f000140020001f00100016005000150127001500170015004000160050001f0130001c0280001f002a0050001a00f000140020001f00100016005000150127001500170015004000160050001f0130001c0280001f002a0050001a00f000140020001f00100016005000150117001500170015005000160050001f0130001c0280001f002a0050001a00f000140020001f00100016005000150107001500170015006000160050001f0130001c0280001f002a0050001a00f000140020001f00100016005000150107001500170015006000160050001f0130001c0280001f002a0050001a00f000140020001f001000160050001500f7001500170015007000160050001f0130001c0280001f002a0050001a00f000140020001f001000160050001500e7001500170015008000160050001f0130001c0280001f002a0024001a0020001a0024001a00c000140020001f001000160050001500e7001500170015008000160050001f0130001c0280001f002a0014003a0010001a0014003a00b000140020001f001000160050001500d7001500170015009000160050001f0130001c0280001f002a0024001a0020001a0024001a00c000140020001f001000160050001500c700150017001500a000160050001f0130001c0280001f002a0050001a00f000140020001f001000160050001500c700150017001500a000160050001f0130001c0280001f002a0050001a00f000140020001f001000160050001500b700150017001500b000160050001f0130001c0280001f002a0050001a00f000140020001f001000160050001500a700150017001500c000160050001f0130001c0280001f002a0050001a00f000140020001f001000160050001500a700150017001500c000160050001f0130001c0280001f002a0050001a00f000140020001f0010001600500015009700150017001500d000160050001f0130001c0280001f002a0050001a00f000140020001f00100016005001b60050001f0130001c0280001f002a0050001a00f000140020001f001000160250001f0130001c0280001f002a0050001a00f000140020001f001000160250001f0130001c0280001f002a0050001a00f000140020001f0010027f0130001c0280001f002a0050001a00f000140020001f001000160250001f0130001c0280001f002a0050001a00f000140020001f001000160250001f0130001c0280001f002a0050001a00f000140020001f0010001600c000d600c0001f0130001c0280001f002001640020001f001000160250001f0130001c0280001f00240180001f001000160250001f0130001c0280001f0020080d0080001d0160001d0160001d0160001d0160001d0160001d00c0001d0160001d0160001d0160001d0160001d0160001d00c0001d0160001d0160001d0160001d0160001d0160001d00c0001d0160001d0160001d0160001d0160001d0160001d0040080d0140001d0160001d0160001d0160001d0160001d0230001d0160001d0160001d0160001d0160001d0230001d0160001d0160001d0160001d0160001d0230001d0160001d0160001d0160001d0160001d00f0080d0080001d0160001d0160001d0160001d0160001d0160001d00c0001d0160001d0160001d0160001d0160001d0160001d00c0001d0160001d0160001d0160001d0160001d0160001d00c0001d0160001d0160001d0160001d0160001d0160001d0040080d0140001d0160001d0160001d0160001d0160001d0230001d0160001d0160001d0160001d0160001d0230001d0160001d0160001d0160001d0160001d0230001d0160001d0160001d0160001d0160001d00f0080d0080001d0160001d0160001d0160001d0160001d0160001d00c0001d0160001d0160001d0160001d0160001d0160001d00c0001d0160001d0160001d0160001d0160001d0160001d00c0001d0160001d0160001d0160001d0160001d0160001d0040080d0140001d0160001d0160001d0160001d0160001d0230001d0160001d0160001d0160001d0160001d0230001d0160001d0160001d0160001d0160001d00f",
			0,0)
		end,
		items=init_kitchen_items()
	}
end

function init_kitchen_items()
	local peg={
		x=75,y=65,w=1,h=1,
		draw=function()
			rf(75,65,76,66,6)
		end,
		act=function()
			msg="a nail in the wall\nto hang things from."
		end
	}
	local tongs={
		name="tongs",
		x=72,y=64,w=7,h=14,
		act=function()
		 scn_rm("tongs")
		 pickup({
		 	name="ice block tongs",
		 	desc="used for carrying\nlarge blocks of ice.",
		 	weight=2679,
		 	sp=49
		 })
		end,
		draw=function()
			sspr(72,8,8,15,72,64)
		end
	}
	local freezer={
		name="freezer",
		x=85,y=30,w=34,h=20,
		act=function()
			pickup({
				name="book",
				desc="the whining - stefan kang",
				weight=294,
				sp=50
			})
			msg="you found a book\nin the freezer. what's\nthat doing in there?"
			scn_rm("freezer")
		end
	}
	return {tongs,peg,freezer}
end

bulb_taken=false
function init_basement()
	return {
		draw=function()
			if bulb_taken then
				rf(0,0,127,127,0)
				return
			end
			draw_encoded("8080101e00011011400210100001100a40021017000110069001103000011011400210100001100a40021017000110069001103000011011400210100001100a40021017000110069001103000011011400210100001100a40021017000110069001103000011011400210100001100a40021017000110069001103000011011400210100001100a40021017000110069001103000011011400210100001100a40021017000110069001103000011011401f1017000110069001103000011011401f1017000110069001101200304002001b4002001e90010012100b0001102300014002101b40021004000110199001100a000110120001102300014002101b40021004000110189002100a000110120001102300014002101b40021004000110186002100a000110120001102300014002101b40021004000110186002100a000110120001102300014002101b40021004000110187002100a000110120001102300014002101b400210040001101770041009000110120001102300014002101b400210040001101670061008000110120001102300014002101b40021004000110167004a00170011008000110120001102300014002101b40021004000110167003a00170021008000110120001102300014002101b40021004000110177004100900011012000110230001401f10040001102400011012000110230001401f10040001101b60011008000110120001102300014002101b4002100400011024000110120001102300014002101b400210040001101b60011008000110120001102300014002101b4002100400011024000110120001102300014002101b400210040001101b60011008000110120001102300014002101b40021004000110240001100700304002001b40020031101e00011011400210100001100a400210170001103700011011400210100001100a400210170001103700011011400210100001100a400210170001103700011011400210100001100a400210170001103700011011400210100001100a400210170001103700011011401f10170001103700011011401f10170001103700011011400210100001100a400210170001103700011011400210100001100a400210170001103700011011400210100001100a400210170001103700011011400210100001100a400210170001103700011011400210100001100a400210170001103700011011400210100001100a400210170001103700011011400210100001100a400210170001103700011011400210100001100a400210170001103700011011400210100001100a400210170001103700011011400210100001100a400210170001101900304002001b40020031100b000110230001401f10040001102300011013000110230001401f100400011023000110130001102300014002101b4002100400011023000110130001102300014002101b4002100400011023000110130001102300014002101b4002100400011023000110130001102300014002101b4002100400011023000110130001102300014002101b4002100400011023000110130001102300014002101b4002100400011023000110130001102300014002101b4002100400011023000110130001102300014002101b4002100400011023000110130001102300014002101b4002100400011023000110130001102300014002101b4002100400011023000110130001102300014002101b400210040001102300011013000110230001401f10040001102300011013000110230001401f100400011023000110130001102300014002101b4002100400011023000110130001102300014002101b40021004000110230001100800304002001b40020031101e00011011400210100001100a400210170001103700011011400210100001100a400210170001103700011011400210100001100a400210170001103700011011400210100001100a400210170001103700011011400210100001100a400210170001103700011011400210100001100a400210170001103700011011400210100001100a400210170001103700011011400210100001100a400210170001103700011011401f10170001103700011011401f10170001103700011011400210100001100a400210170001103700011011400210100001100a400210170001103700011011400210100001100a400210170001103700011011400210100001100a400210170001103700011011400210100001100a400210170001103700011011400210100001100a400210170001103700011011400210100001100a400210170001101900304002001b40020031100b00254002101b40021004000110230001101300254002101b40021004000110230001101300254002101b4002100400011023000110130025401f100400011023000110130025401f1004000110230001101300254002101b40021004000110230001101300254002101b40021004000110230001101300254002101b40021004000110230001101300254002101b40021004000110230001101300254002101b40021004000110230001101300254002101b40021004000110230001101300254002101b40021004000110230001101300254002101b40021004000110230001101300254002101b40021004000110230001101300254002101b40021004000110230001101300254002101b40021004000110230001101300254002101b400210040001102300011008d080501910015005100150061001500610015061100150191001506a1001500c1001507b100150071001506c10015092100150031001506d10015002100150851001505c0003507b0002507c0002507d0001507d0002507b0003506e000a5003000250700001500a000350710001507d0002507d0001507a000550790002507d0001507e0001507e0001507f0001507e0001507b0004507b0001507e00015031",
			0,0)
		end,
		items=init_basement_items()
	}
end

function init_basement_items()
	local ladder={
		x=48,y=0,w=30,h=98,
		act=function()
			go("start")
		end
	}
	local dust={
		x=13,y=100,w=32,h=8,
		act=function()
			msg="there's some brick dust\non the floor."
			--sfx msg
		end
	}
	local hat={
		name="hat",
		hide=true,
		x=16,y=95,w=8,h=4,
		act=function()
			pickup({
				name="hat",
				desc="keeps the sun out of\nyour eyes, and ever\nso fabulously.",
				sp=51,
				weight=308
			})
			scn_rm("hat")
		end,
		draw=function()
			if(not bulb_taken)spr(51,16,93)
		end
	}
	local hatpin={
		name="hatpin",
		hide=true,
		x=30,y=93,w=6,h=6,
		act=function()
			pickup({
				name="hatpin",
				desc="long, thin, and sharp.",
				sp=52,
				weight=12
			})
			scn_rm("hatpin")
		end,
		draw=function()
			if(not bulb_taken)spr(52,29,92)
		end
	}
	local brick={
		name="brick",
		x=12,y=82,w=34,h=16,
		act=function()
			if held==nil then
				msg="this brick feels a\nlittle loose. i\ncan't move it with\nmy bare hands."
			elseif held.name=="ice block tongs" then
				inv_rm("ice block tongs")
				scn_rm("brick")
				hat.hide=false
				hatpin.hide=false
				msg="you remove the brick to\nreveal a lady's hat\nand a hatpin."
				--sfx brick pull
			else
				wrong_item("pull a brick")
			end
		end,
		draw=function()
			if(not bulb_taken)rf(12,82,46,98,1)
		end
	}
	local bulb={
		x=105,y=12,w=8,h=8,
		act=function()
			if not bulb_taken then
				bulb_taken=true
				pickup({
					name="light bulb",
					desc="in case you have\na bright idea.",
					weight=42,
					sp=53
				})
			else
				if held==nil then
					msg="an empty light bulb socket"
					--sfx msg
				elseif held.name=="light bulb" then
					inv_rm("light bulb")
					bulb_taken=false
				else
					wrong_item("fill an empty\nlight bulb socket")
				end
			end
		end
	}
	
	return {
		ladder,dust,brick,hat,hatpin,
		bulb
	}
end

sheet_music_item={
	name="sheet music",
	weight=33,
	desc="\"moonlight sonata\"",
	sp=54
}

function init_piano_rm()
	return {
		l="start",
		draw=function()
			draw_encoded("808027087024205c7024205c7002c00f7002c00f7002205c7002c00f7002c00f7002205c7002c00f7002c00f7002205c7002c00f7002c00f7002205c7002c0077003c0057002c00f7002205c7002c0077006c0027002c0035001c0025001c0087002205c7002c0097004c00160017002c0016001c0015006c0067002205c7002c00f7002c0065001c0087002205c7002c00f7002c00f7002205c7002c00f7002c00f7002205c7002c00f7002c00f7002205c7002c00f7002c00f7002205c7002c00f7002c00f7002205c7002c00f7002c00f7002205c7002c00f7002c00f7002205c7024205c7024205c7002c00f7002c00f7002205c7002c00f7002c00f7002205c7002c00f7002c00f7002205c7002c00f7002c00f7002205c7002c00f7002c00f7002205c7002c00f7002c00f7002205c7002c00f7002c00f7002205c7002c00f7002c00f7002205c7002c00f7002c00f7002205c7002c00f7002c0093003c0037002205c7002c0043005c0067002c004300b7002205c7002c0033007c0057002c003300c7002205c7002c002300ac0037002c003300c7002205c7002c002300bc0027002c004300b7002205c7002c002300bc0027002c004300b7002205c7024205c7024231f4030204f4032204e4032204e4032204e4032204e4032204e403220084039200d403220094037200e403220094037200e403220094004502e4005200e4032200940045001402c50014005200e4032200940045001402c50014005200e00066006000a6006000a60060006200940045001402c50014005200e4004600a4006600a4006600a4004200940045001402c50014005200e4003600c4004600c4004600c4003200940045001402c50014005200e40035001600a500140045001600a500140045001600a50014003200940045001402c50014005200e4004500260065002400650026006500240065002600650024004200940045001402c50014005200e40065006400a5006400a50064006200940045001402c50014005200e4032200940045001402c50014005200e0032200940045001402c50014005200e403220094004502e4005200e4032200940045001402c50014005200e4032200940045001402c50014005200e40322009400450014002000140010001400200014001000140010001400200014001000140020001400100014001000140020001400100014002000140010001400100014002000140010001400350014005200e4032200940045001702c50014005200e401100104011200940045001702c50014005200e401100104011200940045001402c50014005200e401100104011200940045001402c50014005200e40110010401120094004502e4005200e401100104011200940045001402c50014005200e401100104011200940045001402c50014005200e401100104011200940045001402c50014005200e401100104011200940045001402c50014005200e4011001040112009400450014009d01a400950014005200e4011001040112009400450014008d01c400850014005200e40110002400c000240112009400450014008d01c400850014005200e40110002400c000240112009400450014009d01a400950014005200e40110001400e00014011200940045001400a7018400a50014005200e40110001400e00014011200940045001400a700240147002400a50014005200e401100104011200940045001400a700240147002400a50014005200e4032200940045001400a700240147002400a50014005200e4032200940045001400a700240147002400a50014005200e4032200940045001400a700240147002400a50014005200e40322004500540045001400a700240147002400a50014005500e40325004300540045001400a700240069001400290024002900140067002400a50014005300d500140323007500140055001400a700240069001400290024002900140067002400a50014006300c50014032300850107002500590025002900250029002500570025011300c503330177002301670023c53")
		end,
		items=init_piano_rm_items()
	}
end

targets={42,291,5}--bulb,rabbit,pencil
slots={{},{},{}}
weight_box_open=false

function check_weights()
	if(not weight_box_open)return
	for i=1,3 do
		if(slots[i]~=targets[i])return
	end
	get_item("binos").hide=false
	get_item("box door").hide=true
	--sfx open
	weight_box_open=true
end

function drop_zone_activate(self)
	if slots[self.idx].name~=nil then
		if held==nil then
			pickup(slots[self.idx])
			slots[self.idx]={}
		else
			wrong_item("")
			msg="there's already something\non that plate."
		end	
	elseif held==nil then
		msg="a metal plate mounted\nonto a large box with\na door on the front."
		--sfx msg
	else
		slots[self.idx]=held
		inv_rm(held.name)
		--sfx weight box put
	end
	check_weights()
end

function drop_zone_draw(self)
	local item=slots[self.idx]
	if item.sp then
		local osx,osy=item.osx~=nil and item.osx or 0,item.osy~=nil and item.osy or 0
		spr(item.sp,self.x+osx+2,self.y+osy-2)
	end
	print(targets[self.idx],self.x+self.otxt,self.y-8,10)
end

function init_piano_rm_items()
	local window={
		x=9,y=14,w=35,h=36,
		act=function()
			if held==nil then
				msg="such a lovely day\noutside. what a shame\nyou're trapped in here."
				--sfx msg
			elseif held.name=="binoculars" then
				msg="through the binoculars, you\nsee an airplane flying\na banner advertisement\n\"101.1 krlc\""
				--sfx msg
			else
				wrong_item("")
				msg="i'm not sure what that\nwould accomplish."
			end
		end
	}
	local piano={
		x=9,y=76,w=45,h=8,
		act=function()
			go("piano")
		end
	}
	local bench={
		name="bench",
		x=18,y=89,w=27,h=3,
		act=function()
			pickup(sheet_music_item)
			msg="you found sheet music\nin the piano bench.\n\"moonlight sonata\""
			scn_rm("bench")
		end
	}
	local stand={
		name="stand",
		x=17,y=66,w=30,h=9,
		act=function(self)
			if held==nil then
				msg="a place to put\nsheet music."
				--sfx msg
			elseif held.name=="sheet music" then
				self.hide=true
				get_item("stand music").hide=false
				--sfx paper down
			else
				wrong_item("")
				msg="that doesn't go there."	
			end
		end
	}
	local stand_music={
		name="stand music",
		hide=true,
		x=17,y=66,w=30,h=9,
		draw=function()
			sspr(80,0,31,9,17,66)
		end,
		act=function(self)
			pickup(sheet_music_item)
			get_item("stand").hide=false
			self.hide=true
		end
	}
	local binos={
		name="binos",
		hide=true,
		x=96,y=83,w=4,h=7,
		act=function()
			pickup({
				name="binoculars",
				weight=2023,
				desc="look through the small end",
			})
			scn_rm("binos")
		end,
		draw=function()
			spr(55,95,82)
		end
	}
	local door={
		name="box door",
		x=91,y=80,w=15,h=14,
		act=function()
			msg="the door doesn't budge."
		end,
		draw=function()
			rf(92,81,105,93,4)
			circfill(102,87,1,9)
		end
	}
	local bulbslot={
		x=77,y=67,w=11,h=5,
		idx=1,otxt=2,
		act=drop_zone_activate,
		draw=drop_zone_draw
	}
	local rabbitslot={
		x=93,y=67,w=11,h=5,
		idx=2,otxt=0,
		act=drop_zone_activate,
		draw=drop_zone_draw
	}
	local pencilslot={
		x=109,y=67,w=11,h=5,
		idx=3,otxt=4,
		act=drop_zone_activate,
		draw=drop_zone_draw
	}

	return {
		window,piano,bench,stand,
		stand_music,binos,door,
		bulbslot,rabbitslot,
		pencilslot
	}
end


-->8
--inv
inv={}
local w=110
local h=19
local x=6
local y=1
local by=8+y --y of boxes
local iidx=1

function update_inv()
	if btnp(‚û°Ô∏è) and iidx<10 then 
		iidx+=1
		sfx(2)
	elseif btnp(‚¨ÖÔ∏è) and iidx>1 then 
		iidx-=1
		sfx(2)
	elseif btnp(üÖæÔ∏è) then
		held=inv[iidx]
		inv_open=false
		set_ptr_from_inv()
		sfx(3)
	elseif btnp(‚ùé) then
		inv_open=false
		set_ptr_from_inv()
		held=nil
		sfx(5)
	end
end

function set_ptr_from_inv()
	ptr.x=x+(iidx-1)*11+6
	ptr.y=by+6
end

function draw_inv()
	--bg
	rf(x,y,x+w,y+h,0)
	--border
	rect(x,y,x+w,y+h,7)
	--boxes
	for i=0,9 do
		local bx=x+i*11
		rect(
			bx,by,bx+11,by+11,7)
	end
	--header
	print(
		"inventory",x+2,y+2,7)
	--items
	for i,item in ipairs(inv) do
		local ix=x+(i-1)*11+2
		spr(item.sp,ix,by+2)
	end
	--highlight
	local hx=x+(iidx-1)*11
	rect(hx,by,hx+11,by+11,9)
	--item detail window
	local item=inv[iidx]
	if not item then return end
	local desc_lines=
		#split(item.desc,"\n")
	local idh= --item detail hght
		(desc_lines+1)*5+
		desc_lines+5
	local idy=by+11
	--bg
	rf(x,idy,x+w,idy+idh,0)
	--border
	rect(
		x,idy,x+w,idy+idh,7)
	--name
	print(item.name,x+2,idy+2,7)
	--desc
	print(item.desc,x+2,idy+10,7)
	--highlight again...
	rect(hx,by,hx+11,by+11,9)
end

function init_inv_btn()
	inv_btn={
		name="inventory button",
		x=118,y=1,
		w=8,h=8,
		draw=function(self)
			local hvrc=hovered==self and 7 or 12
			rf(
				self.x,
				self.y,
				self.x+self.w,
				self.y+self.h,
				hvrc)
			rect(
				self.x,
				self.y,
				self.x+self.w,
				self.y+self.h,
				1)
			print("i",
				self.x+3,self.y+2,1)
		end,
		act=function(self) 
			inv_open=true
			sfx(4)
			hovered=nil
		end	
	}
end
-->8
--util
function draw_encoded(s,x,y)
	local basex = x or 0
	local basey = y or 0
	local w=tonum('0x'..sub(s,1,2))
	local h=tonum('0x'..sub(s,3,4))
	local rowpx=w
	local x=basex
	local y=basey
	
	for i=5,#s,4 do
		local clr=-1
		local clrchr=sub(s,i,i)		
		if clrchr ~= 'x' then
			clr=tonum('0x'..clrchr)
		end
		local len=tonum('0x'..sub(s,i+1,i+3))
		while len>=rowpx do
			if clr~=-1 then
				line(x,y,x+rowpx-1,y,clr)
			end
			len=len-rowpx
			rowpx=w
			y=y+1
			x=basex
		end
		if len>0 do
			if clr~=-1 then
				line(x,y,x+len-1,y,clr)
			end
			rowpx=rowpx-len
			x=x+len
		end
	end
end
__gfx__
0000000007000700170000000000007101111111fffffffffffffffffffffffffffffffffff00000077777777777777577777777777777000000000000000000
00000000707007001677000000007761016666674444444444444444444444444444444444400000777555555555577577755555555557700000000000000000
00700700070770771666770000776661001666704441111111111111111111111111111444400000775777777777757577577777777775700000000000000000
00077000000007001666666666666661001666704441444444444449999444444444441444400000777777777777777577777777777777700000000000000000
00077000000007001666110000116661000167004441444444444499997944444444441444400000777555555555577577755555555557700000000000000000
00700700000000001611000000001161000167004441444444444449999444444444441444400000775777777777757577577777777775700000000000000000
00000000000000001100000000000011000060004441111111111111111111111111111444400000777777777777777577777777777777700000000000000000
00000000000000000000000000000000000060004444444444444444444444444444444444400000775555555555557577555555555555700000000000000000
eaaaae00000077007700999900e66666666666666666666e04444444444444444444440044444444777777777777777577777777777777700000000000000000
e9999e00077777777779999790665555855555555555556644444444444444444444444044444444000000000000000000000000000000000000000000000000
99979900777777777770999900666666666666666666666644444444444444444444444050000005000000000000000000000000000000000000000000000000
99997900677777777700000000660060060060066633666644444444444444444444444005000050000000000000000000000000000000000000000000000000
99999900066067777000000000660060060060066633666614444444449974444444441000500500000000000000000000000000000000000000000000000000
99999900000006600000000000666666666666666666666641111111119991111111114000055000000000000000000000000000000000000000000000000000
e9999e00000030330000000003665555555555555555556644444444449994444444444000055000000000000000000000000000000000000000000000000000
eaaaae00000333333000000033665666666666666666656644555554455555445555544000500500000000000000000000000000000000000000000000000000
ea00ae00003333333333000033665555555555555555556644599954458885445333544005000050000000000000000000000000000000000000000000000000
ea00ae00003333333333300333665666666666666666656644599954458885445333544050000005000000000000000000000000000000000000000000000000
eaa0ae00003333433333330033665555555555555555556644599954458885445333544050000005000000000000000000000000000000000000000000000000
ea00ae30000333343334333003665666666666666666656644555554455555445555544050000005000000000000000000000000000000000000000000000000
eaaaae33000033343343330333665555555555555555556644444444444444444444444050000005000000000000000000000000000000000000000000000000
eaaaae00000000000000000000666666666666666666666644444444444444444444444005000050000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000044444444444444444444444000500500000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00050000004444009999999900000000000000000006600007777770000000000000000000000000000000000000000000000000000000000000000000000000
000f0000005005009777777700000000000006600006600077555577011011000000000000000000000000000000000000000000000000000000000000000000
000a0000000550009999999700eee700000006600007700075777757055155000000000000000000000000000000000000000000000000000000000000000000
000a000000055000944494970eeeee70000060000077770077777777055155000000000000000000000000000000000000000000000000000000000000000000
000a000000500500999999970eeeee70000600000777777077555577055155000000000000000000000000000000000000000000000000000000000000000000
000a00000500005094494497eeeeeeee0060000007777a7075777757055055000000000000000000000000000000000000000000000000000000000000000000
00060000050000509999999700000000060000000777a77077777777055055000000000000000000000000000000000000000000000000000000000000000000
000e0000005005009999999000000000000000000077770077777777066066000000000000000000000000000000000000000000000000000000000000000000
